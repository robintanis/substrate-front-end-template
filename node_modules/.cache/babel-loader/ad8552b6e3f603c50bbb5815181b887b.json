{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.query = query;\nexports.queryMulti = queryMulti;\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\"); // Copyright 2017-2020 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\n\nfunction parseController(stashId, [controllerIdOpt, nominatorsOpt, rewardDestination, validatorPrefs, exposure], stakingLedgerOpt) {\n  const nominators = nominatorsOpt.unwrapOr(null);\n  return {\n    accountId: stashId,\n    controllerId: controllerIdOpt.unwrapOr(null),\n    exposure,\n    nominators: nominators ? Array.isArray(nominators) ? nominators[0].targets : nominators.targets : [],\n    rewardDestination,\n    stakingLedger: stakingLedgerOpt.unwrapOrDefault(),\n    stashId,\n    validatorPrefs: Array.isArray(validatorPrefs) ? validatorPrefs[0] : validatorPrefs\n  };\n}\n\nfunction retrievePrev(api, stashId) {\n  return api.queryMulti([[api.query.staking.bonded, stashId], [api.query.staking.nominators, stashId], [api.query.staking.payee, stashId], [api.query.staking.validators, stashId], [api.query.staking.stakers, stashId]]);\n}\n\nfunction retrieveCurr(api, stashIds, activeEra) {\n  return (0, _rxjs.combineLatest)([api.query.staking.bonded.multi(stashIds), api.query.staking.nominators ? api.query.staking.nominators.multi(stashIds) : (0, _rxjs.of)(stashIds.map(() => api.registry.createType('Option<Nominations>'))), api.query.staking.payee.multi(stashIds), api.query.staking.validators.multi(stashIds), api.query.staking.erasStakers.multi(stashIds.map(stashId => [activeEra, stashId]))]).pipe((0, _operators.map)(([controllerIdOpt, nominatorsOpt, rewardDestination, validatorPrefs, exposure]) => controllerIdOpt.map((controllerIdOpt, index) => [controllerIdOpt, nominatorsOpt[index], rewardDestination[index], validatorPrefs[index], exposure[index]])));\n}\n\nfunction retrieveControllers(api, optControllerIds) {\n  const ids = optControllerIds.filter(opt => opt.isSome).map(opt => opt.unwrap());\n\n  if (!ids.length) {\n    return (0, _rxjs.of)(optControllerIds.map(() => api.registry.createType('Option<StakingLedger>')));\n  }\n\n  return api.query.staking.ledger.multi(ids).pipe((0, _operators.map)(optLedgers => {\n    let offset = -1;\n    return optControllerIds.map(opt => opt.isSome ? optLedgers[++offset] : api.registry.createType('Option<StakingLedger>'));\n  }));\n}\n/**\n * @description From a stash, retrieve the controllerId and all relevant details\n */\n\n\nfunction query(instanceId, api) {\n  return (0, _util2.memo)(instanceId, accountId => api.derive.staking.queryMulti([accountId]).pipe((0, _operators.map)(([first]) => first)));\n}\n\nfunction queryMulti(instanceId, api) {\n  return (0, _util2.memo)(instanceId, accountIds => accountIds.length ? api.derive.session.indexes().pipe((0, _operators.switchMap)(({\n    activeEra\n  }) => {\n    const stashIds = accountIds.map(accountId => api.registry.createType('AccountId', accountId));\n    return ((0, _util.isFunction)(api.query.staking.erasStakers) ? retrieveCurr(api, stashIds, activeEra) : (0, _rxjs.combineLatest)(stashIds.map(stashId => retrievePrev(api, stashId)))).pipe((0, _operators.switchMap)(results => retrieveControllers(api, results.map(([optController]) => optController)).pipe((0, _operators.map)(stakingLedgerOpts => stashIds.map((stashId, index) => parseController(stashId, results[index], stakingLedgerOpts[index]))))));\n  })) : (0, _rxjs.of)([]));\n}","map":{"version":3,"sources":["/home/robin/substrate-front-end-template/node_modules/@polkadot/api-derive/staking/query.js"],"names":["Object","defineProperty","exports","value","query","queryMulti","_rxjs","require","_operators","_util","_util2","parseController","stashId","controllerIdOpt","nominatorsOpt","rewardDestination","validatorPrefs","exposure","stakingLedgerOpt","nominators","unwrapOr","accountId","controllerId","Array","isArray","targets","stakingLedger","unwrapOrDefault","retrievePrev","api","staking","bonded","payee","validators","stakers","retrieveCurr","stashIds","activeEra","combineLatest","multi","of","map","registry","createType","erasStakers","pipe","index","retrieveControllers","optControllerIds","ids","filter","opt","isSome","unwrap","length","ledger","optLedgers","offset","instanceId","memo","derive","first","accountIds","session","indexes","switchMap","isFunction","results","optController","stakingLedgerOpts"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.query = query;\nexports.queryMulti = queryMulti;\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\");\n\n// Copyright 2017-2020 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nfunction parseController(stashId, [controllerIdOpt, nominatorsOpt, rewardDestination, validatorPrefs, exposure], stakingLedgerOpt) {\n  const nominators = nominatorsOpt.unwrapOr(null);\n  return {\n    accountId: stashId,\n    controllerId: controllerIdOpt.unwrapOr(null),\n    exposure,\n    nominators: nominators ? Array.isArray(nominators) ? nominators[0].targets : nominators.targets : [],\n    rewardDestination,\n    stakingLedger: stakingLedgerOpt.unwrapOrDefault(),\n    stashId,\n    validatorPrefs: Array.isArray(validatorPrefs) ? validatorPrefs[0] : validatorPrefs\n  };\n}\n\nfunction retrievePrev(api, stashId) {\n  return api.queryMulti([[api.query.staking.bonded, stashId], [api.query.staking.nominators, stashId], [api.query.staking.payee, stashId], [api.query.staking.validators, stashId], [api.query.staking.stakers, stashId]]);\n}\n\nfunction retrieveCurr(api, stashIds, activeEra) {\n  return (0, _rxjs.combineLatest)([api.query.staking.bonded.multi(stashIds), api.query.staking.nominators ? api.query.staking.nominators.multi(stashIds) : (0, _rxjs.of)(stashIds.map(() => api.registry.createType('Option<Nominations>'))), api.query.staking.payee.multi(stashIds), api.query.staking.validators.multi(stashIds), api.query.staking.erasStakers.multi(stashIds.map(stashId => [activeEra, stashId]))]).pipe((0, _operators.map)(([controllerIdOpt, nominatorsOpt, rewardDestination, validatorPrefs, exposure]) => controllerIdOpt.map((controllerIdOpt, index) => [controllerIdOpt, nominatorsOpt[index], rewardDestination[index], validatorPrefs[index], exposure[index]])));\n}\n\nfunction retrieveControllers(api, optControllerIds) {\n  const ids = optControllerIds.filter(opt => opt.isSome).map(opt => opt.unwrap());\n\n  if (!ids.length) {\n    return (0, _rxjs.of)(optControllerIds.map(() => api.registry.createType('Option<StakingLedger>')));\n  }\n\n  return api.query.staking.ledger.multi(ids).pipe((0, _operators.map)(optLedgers => {\n    let offset = -1;\n    return optControllerIds.map(opt => opt.isSome ? optLedgers[++offset] : api.registry.createType('Option<StakingLedger>'));\n  }));\n}\n/**\n * @description From a stash, retrieve the controllerId and all relevant details\n */\n\n\nfunction query(instanceId, api) {\n  return (0, _util2.memo)(instanceId, accountId => api.derive.staking.queryMulti([accountId]).pipe((0, _operators.map)(([first]) => first)));\n}\n\nfunction queryMulti(instanceId, api) {\n  return (0, _util2.memo)(instanceId, accountIds => accountIds.length ? api.derive.session.indexes().pipe((0, _operators.switchMap)(({\n    activeEra\n  }) => {\n    const stashIds = accountIds.map(accountId => api.registry.createType('AccountId', accountId));\n    return ((0, _util.isFunction)(api.query.staking.erasStakers) ? retrieveCurr(api, stashIds, activeEra) : (0, _rxjs.combineLatest)(stashIds.map(stashId => retrievePrev(api, stashId)))).pipe((0, _operators.switchMap)(results => retrieveControllers(api, results.map(([optController]) => optController)).pipe((0, _operators.map)(stakingLedgerOpts => stashIds.map((stashId, index) => parseController(stashId, results[index], stakingLedgerOpts[index]))))));\n  })) : (0, _rxjs.of)([]));\n}"]},"metadata":{},"sourceType":"script"}