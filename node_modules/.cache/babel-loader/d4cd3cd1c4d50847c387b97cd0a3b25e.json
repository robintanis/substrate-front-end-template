{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._referendumVotes = _referendumVotes;\nexports._referendumsVotes = _referendumsVotes;\nexports._referendumInfo = _referendumInfo;\nexports.referendumsInfo = referendumsInfo;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\");\n\nvar _util3 = require(\"./util\");\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        (0, _defineProperty2.default)(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction votesPrev(api, referendumId) {\n  return api.query.democracy.votersFor(referendumId).pipe((0, _operators.switchMap)(votersFor => (0, _rxjs.combineLatest)([(0, _rxjs.of)(votersFor), votersFor.length ? api.query.democracy.voteOf.multi(votersFor.map(accountId => [referendumId, accountId])) : (0, _rxjs.of)([]), api.derive.balances.votingBalances(votersFor)])), (0, _operators.map)(([votersFor, votes, balances]) => votersFor.map((accountId, index) => ({\n    accountId,\n    balance: balances[index].votingBalance || api.registry.createType('Balance'),\n    isDelegating: false,\n    vote: votes[index] || api.registry.createType('Vote')\n  }))));\n}\n\nfunction votesCurr(api, referendumId) {\n  return api.query.democracy.votingOf.entries().pipe((0, _operators.map)(allVoting => {\n    const mapped = allVoting.map(([key, voting]) => [key.args[0], voting]);\n    const votes = mapped.filter(([, voting]) => voting.isDirect).map(([accountId, voting]) => [accountId, voting.asDirect.votes.filter(([idx]) => idx.eq(referendumId))]).filter(([, directVotes]) => !!directVotes.length).reduce((result, [accountId, votes]) => // FIXME We are ignoring split votes\n    votes.reduce((result, [, vote]) => {\n      if (vote.isStandard) {\n        result.push(_objectSpread({\n          accountId,\n          isDelegating: false\n        }, vote.asStandard));\n      }\n\n      return result;\n    }, result), []);\n    const delegations = mapped.filter(([, voting]) => voting.isDelegating).map(([accountId, voting]) => [accountId, voting.asDelegating]); // add delegations\n\n    delegations.forEach(([accountId, {\n      balance,\n      conviction,\n      target\n    }]) => {\n      // Are we delegating to a delegator\n      const toDelegator = delegations.find(([accountId]) => accountId.eq(target));\n      const to = votes.find(({\n        accountId\n      }) => accountId.eq(toDelegator ? toDelegator[0] : target)); // this delegation has a target\n\n      if (to) {\n        votes.push({\n          accountId,\n          balance,\n          isDelegating: true,\n          vote: api.registry.createType('Vote', {\n            aye: to.vote.isAye,\n            conviction\n          })\n        });\n      }\n    });\n    return votes;\n  }));\n}\n\nfunction _referendumVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendum => (0, _rxjs.combineLatest)([api.derive.democracy.sqrtElectorate(), (0, _util.isFunction)(api.query.democracy.votingOf) ? votesCurr(api, referendum.index) : votesPrev(api, referendum.index)]).pipe((0, _operators.map)(([sqrtElectorate, votes]) => (0, _util3.calcVotes)(sqrtElectorate, referendum, votes))));\n}\n\nfunction _referendumsVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendums => referendums.length ? (0, _rxjs.combineLatest)(referendums.map(referendum => api.derive.democracy._referendumVotes(referendum))) : (0, _rxjs.of)([]));\n}\n\nfunction _referendumInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, (index, info) => {\n    const status = (0, _util3.getStatus)(info);\n    return status ? api.query.democracy.preimages(status.proposalHash).pipe((0, _operators.map)(preimage => ({\n      image: (0, _util3.parseImage)(api, preimage),\n      imageHash: status.proposalHash,\n      index: api.registry.createType('ReferendumIndex', index),\n      status\n    }))) : (0, _rxjs.of)(null);\n  });\n}\n\nfunction referendumsInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, ids => ids.length ? api.query.democracy.referendumInfoOf.multi(ids).pipe((0, _operators.switchMap)(infos => (0, _rxjs.combineLatest)(ids.map((id, index) => api.derive.democracy._referendumInfo(id, infos[index])))), (0, _operators.map)(infos => infos.filter(referendum => !!referendum))) : (0, _rxjs.of)([]));\n}","map":{"version":3,"sources":["/home/robin/substrate-front-end-template/node_modules/@polkadot/api-derive/democracy/referendumsInfo.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_referendumVotes","_referendumsVotes","_referendumInfo","referendumsInfo","_defineProperty2","_rxjs","_operators","_util","_util2","_util3","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","default","getOwnPropertyDescriptors","defineProperties","votesPrev","api","referendumId","query","democracy","votersFor","pipe","switchMap","combineLatest","of","voteOf","multi","map","accountId","derive","balances","votingBalances","votes","index","balance","votingBalance","registry","createType","isDelegating","vote","votesCurr","votingOf","entries","allVoting","mapped","voting","args","isDirect","asDirect","idx","eq","directVotes","reduce","result","isStandard","asStandard","delegations","asDelegating","conviction","toDelegator","find","to","aye","isAye","instanceId","memo","referendum","sqrtElectorate","isFunction","calcVotes","referendums","info","status","getStatus","preimages","proposalHash","preimage","image","parseImage","imageHash","ids","referendumInfoOf","infos","id"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports._referendumVotes = _referendumVotes;\nexports._referendumsVotes = _referendumsVotes;\nexports._referendumInfo = _referendumInfo;\nexports.referendumsInfo = referendumsInfo;\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _rxjs = require(\"rxjs\");\n\nvar _operators = require(\"rxjs/operators\");\n\nvar _util = require(\"@polkadot/util\");\n\nvar _util2 = require(\"../util\");\n\nvar _util3 = require(\"./util\");\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction votesPrev(api, referendumId) {\n  return api.query.democracy.votersFor(referendumId).pipe((0, _operators.switchMap)(votersFor => (0, _rxjs.combineLatest)([(0, _rxjs.of)(votersFor), votersFor.length ? api.query.democracy.voteOf.multi(votersFor.map(accountId => [referendumId, accountId])) : (0, _rxjs.of)([]), api.derive.balances.votingBalances(votersFor)])), (0, _operators.map)(([votersFor, votes, balances]) => votersFor.map((accountId, index) => ({\n    accountId,\n    balance: balances[index].votingBalance || api.registry.createType('Balance'),\n    isDelegating: false,\n    vote: votes[index] || api.registry.createType('Vote')\n  }))));\n}\n\nfunction votesCurr(api, referendumId) {\n  return api.query.democracy.votingOf.entries().pipe((0, _operators.map)(allVoting => {\n    const mapped = allVoting.map(([key, voting]) => [key.args[0], voting]);\n    const votes = mapped.filter(([, voting]) => voting.isDirect).map(([accountId, voting]) => [accountId, voting.asDirect.votes.filter(([idx]) => idx.eq(referendumId))]).filter(([, directVotes]) => !!directVotes.length).reduce((result, [accountId, votes]) => // FIXME We are ignoring split votes\n    votes.reduce((result, [, vote]) => {\n      if (vote.isStandard) {\n        result.push(_objectSpread({\n          accountId,\n          isDelegating: false\n        }, vote.asStandard));\n      }\n\n      return result;\n    }, result), []);\n    const delegations = mapped.filter(([, voting]) => voting.isDelegating).map(([accountId, voting]) => [accountId, voting.asDelegating]); // add delegations\n\n    delegations.forEach(([accountId, {\n      balance,\n      conviction,\n      target\n    }]) => {\n      // Are we delegating to a delegator\n      const toDelegator = delegations.find(([accountId]) => accountId.eq(target));\n      const to = votes.find(({\n        accountId\n      }) => accountId.eq(toDelegator ? toDelegator[0] : target)); // this delegation has a target\n\n      if (to) {\n        votes.push({\n          accountId,\n          balance,\n          isDelegating: true,\n          vote: api.registry.createType('Vote', {\n            aye: to.vote.isAye,\n            conviction\n          })\n        });\n      }\n    });\n    return votes;\n  }));\n}\n\nfunction _referendumVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendum => (0, _rxjs.combineLatest)([api.derive.democracy.sqrtElectorate(), (0, _util.isFunction)(api.query.democracy.votingOf) ? votesCurr(api, referendum.index) : votesPrev(api, referendum.index)]).pipe((0, _operators.map)(([sqrtElectorate, votes]) => (0, _util3.calcVotes)(sqrtElectorate, referendum, votes))));\n}\n\nfunction _referendumsVotes(instanceId, api) {\n  return (0, _util2.memo)(instanceId, referendums => referendums.length ? (0, _rxjs.combineLatest)(referendums.map(referendum => api.derive.democracy._referendumVotes(referendum))) : (0, _rxjs.of)([]));\n}\n\nfunction _referendumInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, (index, info) => {\n    const status = (0, _util3.getStatus)(info);\n    return status ? api.query.democracy.preimages(status.proposalHash).pipe((0, _operators.map)(preimage => ({\n      image: (0, _util3.parseImage)(api, preimage),\n      imageHash: status.proposalHash,\n      index: api.registry.createType('ReferendumIndex', index),\n      status\n    }))) : (0, _rxjs.of)(null);\n  });\n}\n\nfunction referendumsInfo(instanceId, api) {\n  return (0, _util2.memo)(instanceId, ids => ids.length ? api.query.democracy.referendumInfoOf.multi(ids).pipe((0, _operators.switchMap)(infos => (0, _rxjs.combineLatest)(ids.map((id, index) => api.derive.democracy._referendumInfo(id, infos[index])))), (0, _operators.map)(infos => infos.filter(referendum => !!referendum))) : (0, _rxjs.of)([]));\n}"]},"metadata":{},"sourceType":"script"}